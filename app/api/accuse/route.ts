// ============================================
// API Route: Accuse
// –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–≤–∏–Ω–µ–Ω–∏—è –∏–≥—Ä–æ–∫–∞
// ============================================

import { NextRequest, NextResponse } from 'next/server';
import { checkAccusationReadiness } from '@/lib/evidenceSystem';

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { accused } = body; // –ö–æ–≥–æ –æ–±–≤–∏–Ω—è–µ—Ç –∏–≥—Ä–æ–∫: 'anna', 'boris', –∏–ª–∏ 'viktor'

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–ª–∏–∫–∏
    const accusationStatus = checkAccusationReadiness();

    // –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —É–±–∏–π—Ü–∞ - –í–∏–∫—Ç–æ—Ä
    const isCorrect = accused === 'viktor';

    let result: {
      success: boolean;
      message: string;
      details?: string;
    };

    if (isCorrect) {
      // –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –æ–±–≤–∏–Ω–µ–Ω–∏–µ
      if (accusationStatus.canAccuse) {
        // –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —É–ª–∏–∫ - –ü–û–ë–ï–î–ê
        result = {
          success: true,
          message: 'üéâ –ü–æ–±–µ–¥–∞! –í—ã —Ä–∞—Å–∫—Ä—ã–ª–∏ –¥–µ–ª–æ!',
          details: accusationStatus.hasConfession
            ? '–í–∏–∫—Ç–æ—Ä –ö—Ä—ã–ª–æ–≤ –ø—Ä–∏–∑–Ω–∞–ª—Å—è –≤ —É–±–∏–π—Å—Ç–≤–µ. –û–Ω –ø–æ–¥—Å—ã–ø–∞–ª —è–¥ (–¥–∏–≥–∏—Ç–∞–ª–∏—Å) –≤ –≤–∏—Å–∫–∏ –ì—Ä–æ–º–æ–≤–∞ –≤ –ø—è—Ç–Ω–∏—Ü—É –≤–µ—á–µ—Ä–æ–º. –ú–æ—Ç–∏–≤: —à–∞–Ω—Ç–∞–∂ –∏ –±–æ—Ä—å–±–∞ –∑–∞ –∫–æ–Ω—Ç—Ä–æ–ª—å –∫–æ–º–ø–∞–Ω–∏–∏. –í–∞—à–µ —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –±—ã–ª–æ –±–µ–∑—É–ø—Ä–µ—á–Ω—ã–º!'
            : `–í–∏–∫—Ç–æ—Ä –ö—Ä—ã–ª–æ–≤ –∞—Ä–µ—Å—Ç–æ–≤–∞–Ω –Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ —Å–æ–±—Ä–∞–Ω–Ω—ã—Ö —É–ª–∏–∫ (${accusationStatus.evidenceCount} —É–ª–∏–∫). –û–Ω –æ–±–Ω–∞—Ä—É–∂–∏–ª —Ö–∏—â–µ–Ω–∏—è –ì—Ä–æ–º–æ–≤–∞, –Ω–∞—á–∞–ª —à–∞–Ω—Ç–∞–∂–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ, —Ç—Ä–µ–±—É—è 30% –∫–æ–º–ø–∞–Ω–∏–∏. –ö–æ–≥–¥–∞ –ì—Ä–æ–º–æ–≤ –æ—Ç–∫–∞–∑–∞–ª—Å—è, –í–∏–∫—Ç–æ—Ä –ø–æ–¥—Å—ã–ø–∞–ª —è–¥ –≤ –µ–≥–æ –≤–∏—Å–∫–∏.`,
        };
      } else {
        // –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —É–ª–∏–∫ - –ü–û–†–ê–ñ–ï–ù–ò–ï
        const missingText = accusationStatus.missingEvidence.length > 0
          ? `–í–∞–º –Ω–µ —Ö–≤–∞—Ç–∏–ª–æ –∫–ª—é—á–µ–≤—ã—Ö —É–ª–∏–∫: ${accusationStatus.missingEvidence.map(id => {
              if (id === 'boris_blackmail') return '–ø–æ–∫–∞–∑–∞–Ω–∏—è –ë–æ—Ä–∏—Å–∞ –æ —à–∞–Ω—Ç–∞–∂–µ';
              if (id === 'anna_saw_viktor') return '–ø–æ–∫–∞–∑–∞–Ω–∏—è –ê–Ω–Ω—ã –æ –í–∏–∫—Ç–æ—Ä–µ —É –∫–∞–±–∏–Ω–µ—Ç–∞';
              return id;
            }).join(', ')}.`
          : '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —É–ª–∏–∫ –¥–ª—è –æ–±–≤–∏–Ω–µ–Ω–∏—è.';

        result = {
          success: false,
          message: '‚ùå –í—ã —Å–µ–ª–∏ –≤ –ª—É–∂—É!',
          details: `–í—ã –æ–±–≤–∏–Ω–∏–ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞, –Ω–æ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ (${accusationStatus.evidenceCount} –∏–∑ –º–∏–Ω–∏–º—É–º 5 —É–ª–∏–∫). ${missingText}\n\n–í–∏–∫—Ç–æ—Ä –Ω–∞–Ω—è–ª —Ö–æ—Ä–æ—à–µ–≥–æ –∞–¥–≤–æ–∫–∞—Ç–∞ –∏ –±—ã–ª –æ—Ç–ø—É—â–µ–Ω. –î–µ–ª–æ –∑–∞–∫—Ä—ã—Ç–æ.`,
        };
      }
    } else {
      // –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –æ–±–≤–∏–Ω–µ–Ω–∏–µ - –ü–û–†–ê–ñ–ï–ù–ò–ï
      const accusedName = accused === 'anna' ? '–ê–Ω–Ω—É –°–æ–∫–æ–ª–æ–≤—É' : accused === 'boris' ? '–ë–æ—Ä–∏—Å–∞ –¢–∏—Ç–æ–≤–∞' : '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–≥–æ';
      result = {
        success: false,
        message: '‚ùå –í—ã —Å–µ–ª–∏ –≤ –ª—É–∂—É!',
        details: `–í—ã –æ–±–≤–∏–Ω–∏–ª–∏ ${accusedName}, –Ω–æ —ç—Ç–æ –±—ã–ª –Ω–µ —Ç–æ—Ç —á–µ–ª–æ–≤–µ–∫. –ù–∞—Å—Ç–æ—è—â–∏–π —É–±–∏–π—Ü–∞ ‚Äî –í–∏–∫—Ç–æ—Ä –ö—Ä—ã–ª–æ–≤. –û–Ω –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è –≤–∞—à–µ–π –æ—à–∏–±–∫–æ–π –∏ —Å–∫—Ä—ã–ª—Å—è. –î–µ–ª–æ –∑–∞–∫—Ä—ã—Ç–æ.`,
      };
    }

    return NextResponse.json(result);
  } catch (error) {
    console.error('Error in accuse API:', error);
    return NextResponse.json(
      { error: 'Failed to process accusation' },
      { status: 500 }
    );
  }
}
